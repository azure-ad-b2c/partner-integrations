<?xml version="1.0" encoding="utf-8" ?>
<TrustFrameworkPolicy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" PolicySchemaVersion="0.3.0.0" TenantId="{Settings:Tenant}.onmicrosoft.com" PolicyId="B2C_1A_DFP_SocialLocalMfa_TrustFrameworkExtensions" PublicPolicyUri="http://{Settings:Tenant}.onmicrosoft.com/B2C_1A_DFP_SocialLocalMfa_TrustFrameworkExtensions">

  <BasePolicy>
    <TenantId>{Settings:Tenant}.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_DFP_SocialLocalMfa_TrustFrameworkBase</PolicyId>
  </BasePolicy>

  <BuildingBlocks>
    <ClaimsSchema>

      <ClaimType Id="dfp_device_deviceContextId">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id= "dfp_rest_auth_grant_type">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_rest_auth_scope">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_rest_auth_bearer_token">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_rest_request_payload">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_metadata_trackingId">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_metadata_timeStamp">
        <DataType>dateTime</DataType>
      </ClaimType>

      <ClaimType Id="dfp_user_language">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_email_isEmailValidated">
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="dfp_email_isEmailUsername">
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="dfp_device_ipAddress">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_ssoAuthenticationProvider_authenticationProvider">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_transactionId">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_merchantRuleDecision">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_score0">
        <DataType>int</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_score0_type">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_score0_isRiskScore">
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_score1">
        <DataType>int</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_score1_type">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_riskScore">
        <DataType>int</DataType>
      </ClaimType>

      <ClaimType Id="dfp_response_botScore">
        <DataType>int</DataType>
      </ClaimType>

      <ClaimType Id="dfp_statusType">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_reasonType">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="dfp_challengeType">
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="IsSignUp">
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="IsSignIn">
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="isBreakAuthFlow">
        <DisplayName>Indicates whether the auth flow is breaked</DisplayName>
        <DataType>boolean</DataType>
        <AdminHelpText>Break Auth Flow</AdminHelpText>
      </ClaimType>

      <ClaimType Id="userMessage">
        <DisplayName></DisplayName>
        <DataType>string</DataType>
        <UserHelpText>user message</UserHelpText>
        <UserInputType>Paragraph</UserInputType>
      </ClaimType>

    </ClaimsSchema>

    <ClaimsTransformations>
      <ClaimsTransformation Id="AssertAuthFlowBreaked" TransformationMethod="AssertBooleanClaimIsEqualToValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="isBreakAuthFlow" TransformationClaimType="inputClaim" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="valueToCompareTo" DataType="boolean" Value="false" />
        </InputParameters>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CreateMessageSignupRejected" TransformationMethod="CreateStringClaim">
        <InputParameters>
          <InputParameter Id="value" DataType="string" Value="Your sign-up was rejected by Fraud Protection." />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="userMessage" TransformationClaimType="createdClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CreateMessageSignInRejected" TransformationMethod="CreateStringClaim">
        <InputParameters>
          <InputParameter Id="value" DataType="string" Value="Your sign-in was rejected by Fraud Protection." />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="userMessage" TransformationClaimType="createdClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CreateEmailFromOtherMails" TransformationMethod="GetSingleItemFromStringCollection">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="otherMails" TransformationClaimType="collection" />
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="email" TransformationClaimType="extractedItem" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CopyEmailAddressFromSignInName" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="signInName" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="email" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="GetSystemDateTime" TransformationMethod="GetCurrentDateTime">
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="currentDateTime" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-ConvertAuthSourceToAuthProvier" TransformationMethod="LookupValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="authenticationSource" TransformationClaimType="inputParameterId" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="localAccountAuthentication" DataType="string" Value="MerchantAuth" />
          <InputParameter Id="socialIdpAuthentication" DataType="string" Value="Facebook" />
          <InputParameter Id="errorOnFailedLookup" DataType="boolean" Value="false" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_ssoAuthenticationProvider_authenticationProvider" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-ConvertDecisionToStatusType" TransformationMethod="LookupValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" TransformationClaimType="inputParameterId" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="Approve" DataType="string" Value="Approved" />
          <InputParameter Id="Reject" DataType="string" Value="Rejected" />
          <InputParameter Id="Challenge" DataType="string" Value="Pending" />
          <InputParameter Id="errorOnFailedLookup" DataType="boolean" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_statusType" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-ConvertDecisionToReasonType" TransformationMethod="LookupValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" TransformationClaimType="inputParameterId" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="Approve" DataType="string" Value="None" />
          <InputParameter Id="Reject" DataType="string" Value="None" />
          <InputParameter Id="Challenge" DataType="string" Value="ChallengePending" />
          <InputParameter Id="errorOnFailedLookup" DataType="boolean" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_reasonType" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-ConvertDecisionToChallengeType" TransformationMethod="LookupValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" TransformationClaimType="inputParameterId" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="Approve" DataType="string" Value="None" />
          <InputParameter Id="Reject" DataType="string" Value="None" />
          <InputParameter Id="Challenge" DataType="string" Value="SMS" />
          <InputParameter Id="errorOnFailedLookup" DataType="boolean" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_challengeType" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-CopySignInEmailToEmail" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="signInNames.emailAddress" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="email" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-CopyOtherMailToEmail" TransformationMethod="GetSingleItemFromStringCollection">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="otherMails" TransformationClaimType="collection" />
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="email" TransformationClaimType="extractedItem" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-CreateAccount-RequestPayload" TransformationMethod="GenerateJson">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.trackingId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.signUpId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.customerLocalDate" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.merchantTimeStamp" />
          <InputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" TransformationClaimType="device.deviceContextId" />
          <InputClaim ClaimTypeReferenceId="dfp_device_ipAddress" TransformationClaimType="device.ipAddress" />
          <InputClaim ClaimTypeReferenceId="givenName" TransformationClaimType="user.firstName" />
          <InputClaim ClaimTypeReferenceId="surname" TransformationClaimType="user.lastName" />
          <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="user.username" />
          <InputClaim ClaimTypeReferenceId="dfp_user_language" TransformationClaimType="user.language" />
          <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="email.0.emailValue" />
          <InputClaim ClaimTypeReferenceId="dfp_email_isEmailUsername" TransformationClaimType="email.0.isEmailUsername" />
          <InputClaim ClaimTypeReferenceId="dfp_email_isEmailValidated" TransformationClaimType="email.0.isEmailValidated" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="email.0.emailValidatedDate" />
          <InputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="ssoAuthenticationProvider.displayName" />
          <InputClaim ClaimTypeReferenceId="dfp_ssoAuthenticationProvider_authenticationProvider" TransformationClaimType="ssoAuthenticationProvider.authenticationProvider"/>
        </InputClaims>
        <InputParameters>
          <InputParameter Id="name" DataType="string" Value="AP.AccountCreation"/>
          <InputParameter Id="version" DataType="string" Value="0.5"/>
          <InputParameter Id="metadata.assessmentType" DataType="string" Value="Protect"/>
          <InputParameter Id="device.provider" DataType="string" Value="DFPFingerprinting"/>
          <InputParameter Id="email.0.emailType" DataType="string" Value="Primary"/>
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_rest_request_payload" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-CreateAccountStatus-RequestPayload" TransformationMethod="GenerateJson">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.trackingId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.signUpId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.merchantTimeStamp" />
          <InputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="metadata.userId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="statusDetails.statusDate" />
          <InputClaim ClaimTypeReferenceId="dfp_statusType" TransformationClaimType="statusDetails.statusType" />
          <InputClaim ClaimTypeReferenceId="dfp_reasonType" TransformationClaimType="statusDetails.reasonType" />
          <InputClaim ClaimTypeReferenceId="dfp_challengeType" TransformationClaimType="statusDetails.challengeType" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="name" DataType="string" Value="AP.AccountCreation.Status"/>
          <InputParameter Id="version" DataType="string" Value="0.5"/>
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_rest_request_payload" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-LoginAccount-RequestPayload" TransformationMethod="GenerateJson">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.trackingId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.loginId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.customerLocalDate" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.merchantTimeStamp" />
          <InputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" TransformationClaimType="device.deviceContextId" />
          <InputClaim ClaimTypeReferenceId="dfp_device_ipAddress" TransformationClaimType="device.ipAddress" />
          <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="user.username" />
          <InputClaim ClaimTypeReferenceId="dfp_user_language" TransformationClaimType="user.language" />
          <InputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="user.userId" />
          <InputClaim ClaimTypeReferenceId="displayName" TransformationClaimType="ssoAuthenticationProvider.displayName" />
          <InputClaim ClaimTypeReferenceId="dfp_ssoAuthenticationProvider_authenticationProvider" TransformationClaimType="ssoAuthenticationProvider.authenticationProvider"/>
        </InputClaims>
        <InputParameters>
          <InputParameter Id="name" DataType="string" Value="AP.AccountLogin"/>
          <InputParameter Id="version" DataType="string" Value="0.5"/>
          <InputParameter Id="metadata.assessmentType" DataType="string" Value="Protect"/>
          <InputParameter Id="device.provider" DataType="string" Value="DFPFingerprinting"/>
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_rest_request_payload" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-LoginAccountStatus-RequestPayload" TransformationMethod="GenerateJson">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.trackingId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.loginId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.merchantTimeStamp" />
          <InputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="metadata.userId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="statusDetails.statusDate" />
          <InputClaim ClaimTypeReferenceId="dfp_statusType" TransformationClaimType="statusDetails.statusType" />
          <InputClaim ClaimTypeReferenceId="dfp_reasonType" TransformationClaimType="statusDetails.reasonType" />
          <InputClaim ClaimTypeReferenceId="dfp_challengeType" TransformationClaimType="statusDetails.challengeType" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="name" DataType="string" Value="AP.AccountLogin.Status"/>
          <InputParameter Id="version" DataType="string" Value="0.5"/>
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_rest_request_payload" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-UpdateAccount-RequestPayload" TransformationMethod="GenerateJson">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.trackingId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" TransformationClaimType="metadata.accountUpdateId" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.customerLocalDate" />
          <InputClaim ClaimTypeReferenceId="dfp_metadata_timeStamp" TransformationClaimType="metadata.merchantTimeStamp" />
          <InputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" TransformationClaimType="device.deviceContextId" />
          <InputClaim ClaimTypeReferenceId="dfp_device_ipAddress" TransformationClaimType="device.ipAddress" />
          <InputClaim ClaimTypeReferenceId="givenName" TransformationClaimType="user.firstName" />
          <InputClaim ClaimTypeReferenceId="surname" TransformationClaimType="user.lastName" />
          <InputClaim ClaimTypeReferenceId="email" TransformationClaimType="user.username" />
          <InputClaim ClaimTypeReferenceId="dfp_user_language" TransformationClaimType="user.language" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="name" DataType="string" Value="AP.AccountUpdate"/>
          <InputParameter Id="version" DataType="string" Value="0.5"/>
          <InputParameter Id="metadata.assessmentType" DataType="string" Value="Protect"/>
          <InputParameter Id="device.provider" DataType="string" Value="DFPFingerprinting"/>
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_rest_request_payload" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="DFP-CheckIsScore0RiskScore" TransformationMethod="CompareClaimToValue">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_response_score0_type" TransformationClaimType="inputClaim1" />
        </InputClaims>
        <InputParameters>
          <InputParameter Id="compareTo" DataType="string" Value="Risk" />
          <InputParameter Id="operator" DataType="string" Value="EQUAL" />
          <InputParameter Id="ignoreCase" DataType="string" Value="true" />
        </InputParameters>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_response_score0_isRiskScore" TransformationClaimType="outputClaim" />
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CopyScore0ToRiskScore" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_response_score0" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_response_riskScore" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CopyScore0ToBotScore" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_response_score0" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_response_botScore" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CopyScore1ToRiskScore" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_response_score1" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_response_riskScore" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

      <ClaimsTransformation Id="CopyScore1ToBotScore" TransformationMethod="CopyClaim">
        <InputClaims>
          <InputClaim ClaimTypeReferenceId="dfp_response_score1" TransformationClaimType="inputClaim"/>
        </InputClaims>
        <OutputClaims>
          <OutputClaim ClaimTypeReferenceId="dfp_response_botScore" TransformationClaimType="outputClaim"/>
        </OutputClaims>
      </ClaimsTransformation>

    </ClaimsTransformations>

    <ContentDefinitions>

      <!-- This content definition is to render an error page that displays unhandled errors. -->
      <ContentDefinition Id="api.error">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/Exception.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:globalexception:1.1.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.idpselections">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/IdpSelector.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.0.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.idpselections.signup">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/IdpSelector.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:providerselection:1.0.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.signuporsignin">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/Unified.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:unifiedssp:1.0.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.phonefactor">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/Multifactor.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:multifactor:1.1.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.selfasserted">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/SelfAsserted.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.selfasserted.profileupdate">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/SelfAsserted.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.localaccountsignup">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/SelfAsserted.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0</DataUri>
      </ContentDefinition>

      <ContentDefinition Id="api.localaccountpasswordreset">
        <LoadUri>{Settings:ContentDefinitionBaseUri}/SelfAsserted.html</LoadUri>
        <DataUri>urn:com:microsoft:aad:b2c:elements:contract:selfasserted:1.1.0</DataUri>
      </ContentDefinition>

    </ContentDefinitions>
  </BuildingBlocks>

  <ClaimsProviders>

    <ClaimsProvider>
      <DisplayName>Facebook</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="Facebook-OAUTH">
          <Metadata>
            <Item Key="client_id">{Settings:FacebookClientId}</Item>
            <Item Key="scope">email public_profile</Item>
            <Item Key="ClaimsEndpoint">https://graph.facebook.com/me?fields=id,first_name,last_name,name,email</Item>
          </Metadata>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Local Account SignIn</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="login-NonInteractive">
          <Metadata>
            <Item Key="client_id">{Settings:ProxyIdentityExperienceFrameworkAppId}</Item>
            <Item Key="IdTokenAudience">{Settings:IdentityExperienceFrameworkAppId}</Item>
          </Metadata>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="client_id" DefaultValue="{Settings:ProxyIdentityExperienceFrameworkAppId}" />
            <InputClaim ClaimTypeReferenceId="resource_id" PartnerClaimType="resource" DefaultValue="{Settings:IdentityExperienceFrameworkAppId}" />
          </InputClaims>
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Azure Active Directory</DisplayName>
      <TechnicalProfiles>

        <TechnicalProfile Id="AAD-Common">
          <Metadata>
            <Item Key="ApplicationObjectId">{Settings:ExtensionsObjectId}</Item>
            <Item Key="ClientId">{Settings:ExtensionAppId}</Item>
          </Metadata>
        </TechnicalProfile>

        <TechnicalProfile Id="AAD-UserReadUsingAlternativeSecurityId-NoError">
          <Metadata>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">false</Item>
          </Metadata>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateEmailFromOtherMails"/>
          </OutputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="AAD-UserReadUsingAlternativeSecurityId" />
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Local Account</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="LocalAccountSignUpWithLogonEmail-DFP">
          <DisplayName>Email signup</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
            <Item Key="language.button_continue">Create</Item>
            <Item Key="EnforceEmailVerification">false</Item>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" />
            <InputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="localAccountAuthentication" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_email_isEmailValidated" DefaultValue="false" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_email_isEmailUsername" DefaultValue="true" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_device_ipAddress" DefaultValue="{Context:IPAddress}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_user_language" DefaultValue="{Culture:RFC5646}" AlwaysUseDefaultValue="true" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="email" PartnerClaimType="Verified.Email" Required="true" />
            <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
            <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
            <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" />
            <OutputClaim ClaimTypeReferenceId="newUser" />

            <!-- Optional claims, to be collected from the user -->
            <OutputClaim ClaimTypeReferenceId="displayName" />
            <OutputClaim ClaimTypeReferenceId="givenName" />
            <OutputClaim ClaimTypeReferenceId="surName" />

            <OutputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" />
            <OutputClaim ClaimTypeReferenceId="dfp_transactionId" />
            <OutputClaim ClaimTypeReferenceId="IsSignUp" DefaultValue="true" AlwaysUseDefaultValue="true" />
          </OutputClaims>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-GetToken" />
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-CreateAccount" />
            <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingLogonEmail">
              <Preconditions>
                <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
                  <Value>dfp_merchantRuleDecision</Value>
                  <Value>Reject</Value>
                  <Action>SkipThisValidationTechnicalProfile</Action>
                </Precondition>
              </Preconditions>
            </ValidationTechnicalProfile>
            <!-- Some user ID value is required for the subsequent DFP status call -->
            <ValidationTechnicalProfile ReferenceId="SetEmptyObjectId">
              <Preconditions>
                <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
                  <Value>dfp_merchantRuleDecision</Value>
                  <Value>Reject</Value>
                  <Action>SkipThisValidationTechnicalProfile</Action>
                </Precondition>
              </Preconditions>
            </ValidationTechnicalProfile>
            <ValidationTechnicalProfile ReferenceId="DFP-SetStatus"/>
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-CreateAccountStatus" />
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
        </TechnicalProfile>

        <TechnicalProfile Id="SelfAsserted-LocalAccountSignin-Email-DFP">
          <DisplayName>Local Account Signin</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="SignUpTarget">SignUpWithLogonEmailExchange</Item>
            <Item Key="setting.operatingMode">Email</Item>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
            <Item Key="UserMessageIfClaimsTransformationBooleanValueIsNotEqual">Your sign-in was rejected by Fraud Protection.</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="signInName" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="signInName" Required="true" />
            <OutputClaim ClaimTypeReferenceId="password" Required="true" />
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CopyEmailAddressFromSignInName"/>
          </OutputClaimsTransformations>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="login-NonInteractive" />
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Self Asserted</DisplayName>
      <TechnicalProfiles>

        <TechnicalProfile Id="SelfAsserted-Social-DFP">
          <DisplayName>User ID signup</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
            <Item Key="UserMessageIfClaimsTransformationStringsAreNotEqual">Your sign-up was rejected by Fraud Protection.</Item>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>
          <InputClaims>
            <!-- These claims ensure that any values retrieved in the previous steps (e.g. from an external IDP) are prefilled. 
                 Note that some of these claims may not have any value, for example, if the external IDP did not provide any of
                 these values, or if the claim did not appear in the OutputClaims section of the IDP.
                 In addition, if a claim is not in the InputClaims section, but it is in the OutputClaims section, then its
                 value will not be prefilled, but the user will still be prompted for it (with an empty value). -->
            <InputClaim ClaimTypeReferenceId="email" />
            <InputClaim ClaimTypeReferenceId="displayName" />
            <InputClaim ClaimTypeReferenceId="givenName" />
            <InputClaim ClaimTypeReferenceId="surname" />

            <InputClaim ClaimTypeReferenceId="dfp_email_isEmailValidated" DefaultValue="false" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_email_isEmailUsername" DefaultValue="false" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_device_ipAddress" DefaultValue="{Context:IPAddress}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="dfp_user_language" DefaultValue="{Culture:RFC5646}" AlwaysUseDefaultValue="true" />
          </InputClaims>
          <OutputClaims>
            <!-- These claims are not shown to the user because their value is obtained through the "ValidationTechnicalProfiles"
                 referenced below, or a default value is assigned to the claim. A claim is only shown to the user to provide a 
                 value if its value cannot be obtained through any other means. -->
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="newUser" />
            <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />

            <!-- Optional claims. These claims are collected from the user and can be modified. If a claim is to be persisted in the directory after having been 
                 collected from the user, it needs to be added as a PersistedClaim in the ValidationTechnicalProfile referenced below, i.e. 
                 in AAD-UserWriteUsingAlternativeSecurityId. -->
            <OutputClaim ClaimTypeReferenceId="email" Required="true" />
            <OutputClaim ClaimTypeReferenceId="displayName" />
            <OutputClaim ClaimTypeReferenceId="givenName" />
            <OutputClaim ClaimTypeReferenceId="surname" />

            <OutputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" />
            <OutputClaim ClaimTypeReferenceId="dfp_transactionId" />
            <OutputClaim ClaimTypeReferenceId="IsSignUp" DefaultValue="true" AlwaysUseDefaultValue="true" />
          </OutputClaims>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-GetToken" />
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-CreateAccount" />
            <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingAlternativeSecurityId">
              <Preconditions>
                <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
                  <Value>dfp_merchantRuleDecision</Value>
                  <Value>Reject</Value>
                  <Action>SkipThisValidationTechnicalProfile</Action>
                </Precondition>
              </Preconditions>
            </ValidationTechnicalProfile>
            <!-- Some user ID value is required for the subsequent DFP status call -->
            <ValidationTechnicalProfile ReferenceId="SetEmptyObjectId">
              <Preconditions>
                <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
                  <Value>dfp_merchantRuleDecision</Value>
                  <Value>Reject</Value>
                  <Action>SkipThisValidationTechnicalProfile</Action>
                </Precondition>
              </Preconditions>
            </ValidationTechnicalProfile>
            <ValidationTechnicalProfile ReferenceId="DFP-SetStatus"/>
            <ValidationTechnicalProfile ReferenceId="RestApi-DFP-CreateAccountStatus" />
          </ValidationTechnicalProfiles>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-SocialSignup" />
        </TechnicalProfile>

        <TechnicalProfile Id="SelfAsserted-ShowMessage-SignupRejected">
          <DisplayName>ShowMessage-SignupRejected</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="UserMessageIfClaimsTransformationBooleanValueIsNotEqual">Your sign-up was rejected by Fraud Protection.</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="CreateMessageSignupRejected" />
          </InputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="SelfAsserted-ShowMessage"/>
        </TechnicalProfile>

        <TechnicalProfile Id="SelfAsserted-ShowMessage-SignInRejected">
          <DisplayName>ShowMessage-SignInRejected</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="UserMessageIfClaimsTransformationBooleanValueIsNotEqual">Your sign-in was rejected by Fraud Protection.</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="CreateMessageSignInRejected" />
          </InputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="SelfAsserted-ShowMessage"/>
        </TechnicalProfile>

        <TechnicalProfile Id="SelfAsserted-ShowMessage">
          <DisplayName>Show Message</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.selfasserted</Item>
            <Item Key="setting.showContinueButton">false</Item>
            <Item Key="setting.showCancelButton">false</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="userMessage"/>
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="userMessage"/>
          </OutputClaims>
          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="BreakAuthFlow" />
          </ValidationTechnicalProfiles>
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Rest APIs</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="RestApi-DFP-GetToken">
          <DisplayName>DFP Auth</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ServiceUrl">https://login.microsoftonline.com/{Settings:DfpTenantId}/oauth2/v2.0/token</Item>
            <Item Key="AuthenticationType">Basic</Item>
            <Item Key="SendClaimsIn">Form</Item>
          </Metadata>
          <CryptographicKeys>
            <Key Id="BasicAuthenticationUsername" StorageReferenceId="{Settings:DfpAppClientIdKeyContainer}" />
            <Key Id="BasicAuthenticationPassword" StorageReferenceId="{Settings:DfpAppClientSecretKeyContainer}" />
          </CryptographicKeys>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="dfp_rest_auth_grant_type" PartnerClaimType="grant_type" DefaultValue="client_credentials" />
            <InputClaim ClaimTypeReferenceId="dfp_rest_auth_scope" PartnerClaimType="scope" DefaultValue="{Settings:DfpApiAuthScope}" />
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_rest_auth_bearer_token" PartnerClaimType="access_token" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="GetSystemDateTime" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-GetTokenAndInitClaims">
          <DisplayName>DFP Setup and Auth</DisplayName>
          <Metadata>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
          </Metadata>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_metadata_trackingId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="dfp_device_deviceContextId" DefaultValue="{Context:CorrelationId}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="dfp_device_ipAddress" DefaultValue="{Context:IPAddress}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="dfp_user_language" DefaultValue="{Culture:RFC5646}" AlwaysUseDefaultValue="true" />
          </OutputClaims>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-GetToken" />
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-AbstractBase">
          <DisplayName>DFP Create Account</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.RestfulProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="AuthenticationType">Bearer</Item>
            <Item Key="UseClaimAsBearerToken">dfp_rest_auth_bearer_token</Item>
            <Item Key="AllowInsecureAuthInProduction">false</Item>
            <Item Key="SendClaimsIn">Body</Item>
            <Item Key="ClaimUsedForRequestPayload">dfp_rest_request_payload</Item>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
            <Item Key="ResolveJsonPathsInJsonTokens">true</Item>
          </Metadata>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="dfp_rest_auth_bearer_token" />
            <InputClaim ClaimTypeReferenceId="dfp_rest_request_payload" />
          </InputClaims>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-CreateAccount">
          <DisplayName>DFP Create Account</DisplayName>
          <Metadata>
            <Item Key="ServiceUrl">{Settings:DfpApiBaseUrl}action/account/create/dummyValue</Item>
          </Metadata>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="DFP-ConvertAuthSourceToAuthProvier" />
            <InputClaimsTransformation ReferenceId="DFP-CreateAccount-RequestPayload" />
          </InputClaimsTransformations>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_transactionId" PartnerClaimType="transactionReferenceId" />
            <OutputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" PartnerClaimType="resultDetails[0].decision"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0" PartnerClaimType="resultDetails[0].scores[0].scoreValue"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0_type" PartnerClaimType="resultDetails[0].scores[0].scoreType" DefaultValue="none" />
            <OutputClaim ClaimTypeReferenceId="dfp_response_score1" PartnerClaimType="resultDetails[0].scores[1].scoreValue"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score1_type" PartnerClaimType="resultDetails[0].scores[1].scoreType"/>
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="DFP-CheckIsScore0RiskScore" />
          </OutputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-AbstractBase"/>
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-CreateAccountStatus">
          <DisplayName>DFP Create Account Status</DisplayName>
          <Metadata>
            <Item Key="ServiceUrl">{Settings:DfpApiBaseUrl}observe/account/create/status/dummyValue</Item>
          </Metadata>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="DFP-CreateAccountStatus-RequestPayload" />
          </InputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-AbstractBase"/>
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-LoginAccount">
          <DisplayName>DFP Login</DisplayName>
          <Metadata>
            <Item Key="ServiceUrl">{Settings:DfpApiBaseUrl}action/account/login/dummyValue</Item>
          </Metadata>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="DFP-ConvertAuthSourceToAuthProvier" />
            <InputClaimsTransformation ReferenceId="DFP-LoginAccount-RequestPayload" />
          </InputClaimsTransformations>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_transactionId" PartnerClaimType="transactionReferenceId" />
            <OutputClaim ClaimTypeReferenceId="dfp_merchantRuleDecision" PartnerClaimType="resultDetails[0].decision"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0" PartnerClaimType="resultDetails[0].scores[0].scoreValue"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0_type" PartnerClaimType="resultDetails[0].scores[0].scoreType" DefaultValue="none" />
            <OutputClaim ClaimTypeReferenceId="dfp_response_score1" PartnerClaimType="resultDetails[0].scores[1].scoreValue"/>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score1_type" PartnerClaimType="resultDetails[0].scores[1].scoreType"/>
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="DFP-CheckIsScore0RiskScore" />
          </OutputClaimsTransformations>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-AbstractBase"/>
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-LoginAccountStatus">
          <DisplayName>DFP Login Status</DisplayName>
          <Metadata>
            <Item Key="ServiceUrl">{Settings:DfpApiBaseUrl}observe/account/login/status/dummyValue</Item>
          </Metadata>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="DFP-LoginAccountStatus-RequestPayload" />
          </InputClaimsTransformations>
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="dfp_transactionId" PartnerClaimType="LoginId" />
            <InputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="UserId" />
          </InputClaims>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-AbstractBase"/>
        </TechnicalProfile>

        <TechnicalProfile Id="RestApi-DFP-UpdateAccount">
          <DisplayName>DFP Update Account</DisplayName>
          <Metadata>
            <Item Key="ServiceUrl">{Settings:DfpApiBaseUrl}observe/account/update/dummyValue</Item>
          </Metadata>
          <InputClaimsTransformations>
            <InputClaimsTransformation ReferenceId="DFP-ConvertAuthSourceToAuthProvier" />
            <InputClaimsTransformation ReferenceId="DFP-UpdateAccount-RequestPayload" />
          </InputClaimsTransformations>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_transactionId" PartnerClaimType="transactionReferenceId" />
          </OutputClaims>
          <IncludeTechnicalProfile ReferenceId="RestApi-DFP-AbstractBase"/>
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

    <ClaimsProvider>
      <DisplayName>Claim Transformation</DisplayName>

      <TechnicalProfiles>
        <TechnicalProfile Id="BreakAuthFlow">
          <DisplayName>BreakAuthFlow</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="isBreakAuthFlow" DefaultValue="true"/>
          </InputClaims>
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="isBreakAuthFlow" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="AssertAuthFlowBreaked" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="SetEmptyObjectId">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" DefaultValue="00000000-0000-0000-0000-000000000000" AlwaysUseDefaultValue="true" />
          </OutputClaims>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-SetStatus">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <!-- Dummy value changed by subsequent transformation -->
            <OutputClaim ClaimTypeReferenceId="dfp_statusType" DefaultValue="Pending" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="DFP-ConvertDecisionToStatusType" />
            <OutputClaimsTransformation ReferenceId="DFP-ConvertDecisionToReasonType" />
            <OutputClaimsTransformation ReferenceId="DFP-ConvertDecisionToChallengeType" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-SetStatus-AfterSmsChallenge">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_statusType" DefaultValue="Approved" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="dfp_reasonType" DefaultValue="ChallengePassed" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="dfp_challengeType" DefaultValue="SMS" AlwaysUseDefaultValue="true" />
          </OutputClaims>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-CopyScore0ToRiskScore">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0_isRiskScore" DefaultValue="true" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CopyScore0ToRiskScore" />
            <OutputClaimsTransformation ReferenceId="CopyScore1ToBotScore" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-CopyScore1ToRiskScore">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="dfp_response_score0_isRiskScore" DefaultValue="false" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CopyScore1ToRiskScore" />
            <OutputClaimsTransformation ReferenceId="CopyScore0ToBotScore" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-CopySignInEmailToEmail">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="email" DefaultValue="(nil)" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="DFP-CopySignInEmailToEmail" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

        <TechnicalProfile Id="DFP-CopyOtherMailToEmail">
          <DisplayName>Set DFP Status</DisplayName>
          <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="email" DefaultValue="(nil)" />
          </OutputClaims>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="DFP-CopyOtherMailToEmail" />
          </OutputClaimsTransformations>
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-Noop" />
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>
  </ClaimsProviders>

  <UserJourneys>
    <UserJourney Id="SignUpOrSignIn-Dfp">
      <OrchestrationSteps>

        <OrchestrationStep Order="1" Type="CombinedSignInAndSignUp" ContentDefinitionReferenceId="api.signuporsignin">
          <ClaimsProviderSelections>
            <ClaimsProviderSelection TargetClaimsExchangeId="FacebookExchange" />
            <ClaimsProviderSelection ValidationClaimsExchangeId="LocalAccountSigninEmailExchange" />
          </ClaimsProviderSelections>
          <ClaimsExchanges>
            <ClaimsExchange Id="LocalAccountSigninEmailExchange" TechnicalProfileReferenceId="SelfAsserted-LocalAccountSignin-Email-DFP" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Check if the user has selected to sign in using one of the social providers -->
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="FacebookExchange" TechnicalProfileReferenceId="Facebook-OAUTH" />
            <ClaimsExchange Id="SignUpWithLogonEmailExchange" TechnicalProfileReferenceId="LocalAccountSignUpWithLogonEmail-DFP" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- For social IDP authentication, attempt to find the user account in the directory. -->
        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>localAccountAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserReadUsingAlternativeSecurityId" TechnicalProfileReferenceId="AAD-UserReadUsingAlternativeSecurityId-NoError" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Show self-asserted page only if the directory does not have the user account already (i.e. we do not have an objectId). 
          This can only happen when authentication happened using a social IDP. If local account was created or authentication done
          using ESTS in step 2, then an user account must exist in the directory by this time. -->
        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>localAccountAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="SelfAsserted-Social" TechnicalProfileReferenceId="SelfAsserted-Social-DFP" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="5" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>IsSignUp</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Value>Reject</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="ShowMessage-SignupRejected" TechnicalProfileReferenceId="SelfAsserted-ShowMessage-SignupRejected" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- This step reads any user attributes that we may not have received when authenticating using ESTS so they can be sent 
          in the token. -->
        <OrchestrationStep Order="6" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>socialIdpAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="7" Type="InvokeSubJourney">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>objectIdFromSession</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>IsSignUp</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <JourneyList>
            <Candidate SubJourneyReferenceId="PerformSignInFraudCheck" />
          </JourneyList>
        </OrchestrationStep>

        <!-- The previous step (SelfAsserted-Social) could have been skipped if there were no attributes to collect 
             from the user. So, in that case, create the user in the directory if one does not already exist 
             (verified using objectId which would be set from the last step if account was created in the directory. -->
        <OrchestrationStep Order="8" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserWrite" TechnicalProfileReferenceId="AAD-UserWriteUsingAlternativeSecurityId" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="9" Type="InvokeSubJourney">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>isActiveMFASession</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <JourneyList>
            <Candidate SubJourneyReferenceId="EnrollOrPerformSmsMfa" />
          </JourneyList>
        </OrchestrationStep>

        <OrchestrationStep Order="10" Type="InvokeSubJourney">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_response_score0</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_response_score1</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_response_score0_isRiskScore</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <JourneyList>
            <Candidate SubJourneyReferenceId="FormatBotAndRiskScore" />
          </JourneyList>
        </OrchestrationStep>

        <OrchestrationStep Order="11" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

      </OrchestrationSteps>
      <ClientDefinition ReferenceId="DefaultWeb" />
    </UserJourney>

    <UserJourney Id="ProfileEdit-Dfp">
      <OrchestrationSteps>

        <OrchestrationStep Order="1" Type="ClaimsProviderSelection" ContentDefinitionReferenceId="api.idpselections">
          <ClaimsProviderSelections>
            <ClaimsProviderSelection TargetClaimsExchangeId="FacebookExchange" />
            <ClaimsProviderSelection TargetClaimsExchangeId="LocalAccountSigninEmailExchange" />
          </ClaimsProviderSelections>
        </OrchestrationStep>
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="FacebookExchange" TechnicalProfileReferenceId="Facebook-OAUTH" />
            <ClaimsExchange Id="LocalAccountSigninEmailExchange" TechnicalProfileReferenceId="SelfAsserted-LocalAccountSignin-Email" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>localAccountAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserRead" TechnicalProfileReferenceId="AAD-UserReadUsingAlternativeSecurityId" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>socialIdpAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- If the user ever stepped up to use 2FA, profile update must verify this because the user will be able to change
          their sign in email address or strong authentication email here. This guards against scenarios where a user's 
          password is stolen, the attacker can change the email addresses leaving no way for the user to recover their account.
          By requiring 2FA, stolen passwords cannot be used to take over the account completely. -->
        <OrchestrationStep Order="5" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="PhoneFactor" TechnicalProfileReferenceId="PhoneFactor-InputOrVerify" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="6" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="B2CUserProfileUpdateExchange" TechnicalProfileReferenceId="SelfAsserted-ProfileUpdate" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- DFP Account Update -->
        <OrchestrationStep Order="7" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>localAccountAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="DFP-CopyOtherMailToEmail" TechnicalProfileReferenceId="DFP-CopyOtherMailToEmail" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="8" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>authenticationSource</Value>
              <Value>socialIdpAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="DFP-CopySignInEmailToEmail" TechnicalProfileReferenceId="DFP-CopySignInEmailToEmail" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="9" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="Dfp-GetTokenAndInitClaims" TechnicalProfileReferenceId="RestApi-DFP-GetTokenAndInitClaims" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="10" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="DFP-UpdateAccount" TechnicalProfileReferenceId="RestApi-DFP-UpdateAccount" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="11" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

      </OrchestrationSteps>
      <ClientDefinition ReferenceId="DefaultWeb" />
    </UserJourney>

    <UserJourney Id="PasswordReset">
      <OrchestrationSteps>
        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserReadWithObjectId" TechnicalProfileReferenceId="AAD-UserReadUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="5" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />
      </OrchestrationSteps>
      <ClientDefinition ReferenceId="DefaultWeb" />
    </UserJourney>
  </UserJourneys>

  <SubJourneys>
    <SubJourney Id="PerformSignInFraudCheck" Type="Call">
      <OrchestrationSteps>
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="Dfp-GetTokenAndInitClaims" TechnicalProfileReferenceId="RestApi-DFP-GetTokenAndInitClaims" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="Dfp-LoginAccount" TechnicalProfileReferenceId="RestApi-DFP-LoginAccount" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="Dfp-SetStatus" TechnicalProfileReferenceId="DFP-SetStatus" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="Dfp-LoginAccountStatus" TechnicalProfileReferenceId="RestApi-DFP-LoginAccountStatus" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="5" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Value>Reject</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="ShowMessage-SignInRejected" TechnicalProfileReferenceId="SelfAsserted-ShowMessage-SignInRejected" />
          </ClaimsExchanges>
        </OrchestrationStep>
      </OrchestrationSteps>
    </SubJourney>

    <SubJourney Id="EnrollOrPerformSmsMfa" Type="Call">
      <OrchestrationSteps>
        <!-- Phone verification: If MFA is not required, the next three steps (#5-#7) should be removed.
             This step checks whether there's a phone number on record,  for the user. If found, then the user is challenged to verify it. -->
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>strongAuthenticationPhoneNumber</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="PhoneFactor-Verify" TechnicalProfileReferenceId="PhoneFactor-InputOrVerify" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Value>Challenge</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="PhoneFactor-Verify-DfpChallenge" TechnicalProfileReferenceId="PhoneFactor-InputOrVerify" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>IsSignUp</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Value>Challenge</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="DFP-SetStatus-Approved" TechnicalProfileReferenceId="DFP-SetStatus-AfterSmsChallenge" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>IsSignUp</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="false">
              <Value>dfp_merchantRuleDecision</Value>
              <Value>Challenge</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="DFP-LoginAccountStatus-Approved" TechnicalProfileReferenceId="RestApi-DFP-LoginAccountStatus" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Save MFA phone number: The precondition verifies whether the user provided a new number in the 
             previous step. If so, then the phone number is stored in the directory for future authentication 
             requests. -->
        <OrchestrationStep Order="5" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>newPhoneNumberEntered</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="AADUserWriteWithObjectId" TechnicalProfileReferenceId="AAD-UserWritePhoneNumberUsingObjectId" />
          </ClaimsExchanges>
        </OrchestrationStep>
      </OrchestrationSteps>
    </SubJourney>

    <SubJourney Id="FormatBotAndRiskScore" Type="Call">
      <OrchestrationSteps>
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>dfp_response_score0_isRiskScore</Value>
              <Value>False</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="CopyScore0ToRiskScore" TechnicalProfileReferenceId="DFP-CopyScore0ToRiskScore" />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <Preconditions>
            <Precondition Type="ClaimEquals" ExecuteActionsIf="true">
              <Value>dfp_response_score0_isRiskScore</Value>
              <Value>True</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="CopyScore1ToRiskScore" TechnicalProfileReferenceId="DFP-CopyScore1ToRiskScore" />
          </ClaimsExchanges>
        </OrchestrationStep>
      </OrchestrationSteps>
    </SubJourney>
  </SubJourneys>

</TrustFrameworkPolicy>
